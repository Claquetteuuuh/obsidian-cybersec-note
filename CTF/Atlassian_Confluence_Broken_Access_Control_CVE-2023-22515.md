See https://blog.qualys.com/vulnerabilities-threat-research/2023/11/15/atlassian-confluence-broken-access-control-vulnerability-cve-2023-22515
# What is Atlassian confluence
This is a software that permit the team to work together.
The fonctionnalities are:
- Creation of flexible page to take notes
- Manage projects
- Creation of blog for the internal communication
# About the CVE
It able attackers to create admin confluence account and access confluence instance.
Event if this vulnerability is a broken access control, it require a injection that edit the configuration of the application and allow an ilimited access to the admin configuraiton endpoints.

It affect the versions: 8.0.0, 8.0.1, 8.0.2, 8.0.3, 8.0.4, 8.1.0, 8.1.1, 8.1.3, 8.1.4, 8.2.0, 8.2.1, 8.2.2, 8.2.3, 8.3.0, 8.3.1, 8.3.2, 8.4.0, 8.4.1, 8.4.2, 8.5.0, 8.5.1 and it is patched in 8.3.3, 8.4.3 and 8.5.2+.
# Exploit
The exploit chain is in 3 steps:
- Edit the setup completion status of the Confluence application, it give an ilimited access to the administrator configuration page.
- Evade the XSRF security check, it allow the attacker to create an administrator account.
- Leave the installation assistant to prevent the "setup successfully" message from being displayed to all users.
## Vulnerability analysis
### Step 1: Flipping setup completion status

_**GET /server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false**_
The "success" response confirms that the server is operational and doesn't expose sensitive or detailed information directly through this endpoint.
![[Pasted image 20250323154110.png]]

Here is the code of **serverInfoAction**:
```java
package com.atlassian.confluence.core.actions; 
import com.atlassian.annotations.security.XsrfProtectionExcluded; 
import com.atlassian.confluence.core.ConfluenceActionSupport; 
import com.atlassian.confluence.security.access.annotations.PublicAccess; 
import com.atlassian.xwork.HttpMethod;
import com.atlassian.xwork.PermittedMethods; 
public class ServerInfoAction extends ConfluenceActionSupport { 

	@PermittedMethods({HttpMethod.ANY_METHOD})  
	@XsrfProtectionExcluded   
	@PublicAccess   
	public String execute() throws Exception {     
		return "success";
	} 
}
```
This code excluse the XSRF protection and return a success message.

Globally here is the lifecycle of the call of getBootstrapStatusProvider:
- **getBootstrapStatusProvider()**: This method is called to obtain an instance of BootstrapStatusProvider.
- **getApplicationConfig()**: This function is called on the result of getBootstrapStatusProvider(). It get the ApplicationConfig object. This object manage the configuration settings of the application including the **setupComplete** state.
- **setSetupComplete()**: this is called on the ApplicationConfig object. This define the state of setupComplete on true or false.

We can efficiently define the value of setupComplete on false with:
`getBootstrapStatusProvider().getApplicationConfig().setSetupComplete(false)`

Confluence use the XWork2 framework, in this framework the HTTP parameters are used to defined the properties of the actions classes.

With this we can create an http parameter that enable a series of method invokation:
`bootstrapStatusProvider.applicationConfig.setupComplete=false`
## Step 2: Access the setupadministrator endpoint
Now we can access the setup administrator.action endpoint and create an admin account.

But when we send a POST request to this endpoint we receive an 403 status with the body: "_Your request could not be processed because a required security token was not present in the request. You may need to re-submit the form or reload the page_."
![[Pasted image 20250323160517.png]]
![[Pasted image 20250323160525.png]]
This is due to the:
"Scripts that access Confluence remotely may have trouble acquiring or returning a security token or maintaining an HTTP session with the server. To opt out of token checking, include the following HTTP header in the request":
**`X-Atlassian-Token: no-check`**
![[Pasted image 20250323160800.png]]
That worked, now we have gained unrestricted access to the endpoint. All that's left is to include the POST request body with the necessary parameters for the administrator account.

![[Pasted image 20250323161007.png]]
A 302 redirect at the /setup/finishsetup.action endpoint is a sign of a successful request.
## Step 3: Finishing setup
You can login to the administrator dashboard.
![[Pasted image 20250323161344.png]]
# Mitigation
## Détection de l'exploitation de la vulnérabilité sur un SIEM

## Types de logs à collecter

Pour détecter efficacement l'exploitation de cette vulnérabilité, plusieurs types de logs doivent être collectés et analysés :

## Logs d'accès web et applicatifs

- **Logs d'accès HTTP du serveur web** : Ces logs sont essentiels car ils enregistrent toutes les requêtes faites au serveur Confluence, y compris les chemins d'URL, les paramètres, les en-têtes et les codes de réponse1. Ils permettront d'identifier les requêtes vers les endpoints critiques mentionnés dans le processus d'exploitation.
    
- **Logs applicatifs de Confluence** : Ils fournissent des informations détaillées sur le comportement interne de l'application et peuvent révéler des tentatives de modification de la configuration ou des accès aux fonctionnalités d'administration.
## Logs d'authentification et de sécurité

- **Logs d'authentification** : Ces logs enregistrent les tentatives de connexion, réussies ou échouées, ainsi que la création de nouveaux comptes, particulièrement importants pour détecter la création non autorisée de comptes administrateurs.
    
- **Logs des pare-feu et équilibreurs de charge** : Ils permettent d'observer le trafic réseau entrant et sortant vers les serveurs Confluence, aidant à identifier des modèles de trafic suspects ou des connexions depuis des sources inhabituelle.
## Règles à implémenter pour détecter l'exploitation

Sur la base du mécanisme d'exploitation détaillé précédemment, voici les règles SIEM recommandées pour détecter cette vulnérabilité :

## Détection de la première phase d'exploitation

- **Règle 1** : Alerter sur toute requête GET vers "/server-info.action" contenant le paramètre "bootstrapStatusProvider.applicationConfig.setupComplete=false".
    
    - Exemple de signature : `GET /server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false`
    - Priorité : Haute (cette requête est un indicateur fort de tentative d'exploitation)
## Détection du contournement de la sécurité XSRF

- **Règle 2** : Identifier les requêtes avec l'en-tête "X-Atlassian-Token: no-check" dirigées vers des endpoints sensibles, particulièrement "/setup/setupadministrator.action".
    
    - Exemple de signature : En-tête HTTP contenant `X-Atlassian-Token: no-check` vers des URLs contenant `/setup/`
        
    - Priorité : Moyenne à haute
        

## Détection de la création de compte administrateur

- **Règle 3** : Surveiller les requêtes POST vers "/setup/setupadministrator.action" qui tentent de créer de nouveaux comptes administrateurs.
    
    - Signature : `POST /setup/setupadministrator.action` avec des paramètres de création de compte
        
    - Priorité : Haute
        

## Détection de la finalisation de l'exploitation

- **Règle 4** : Alerter sur les requêtes POST vers "/setup/finishsetup.action" qui complètent le processus d'exploitation.
    
    - Signature : `POST /setup/finishsetup.action`
        
    - Priorité : Moyenne (isolée), Haute (en corrélation avec d'autres indicateurs)
        

## Règles de corrélation

- **Règle 5** : Corréler temporellement les événements correspondant aux trois phases d'exploitation se produisant dans une fenêtre de quelques minutes et provenant de la même adresse IP.
    
    - Cette règle composite augmente considérablement la confiance dans la détection d'une véritable exploitation
        

## Surveillance comportementale

- **Règle 6** : Détecter les connexions administratives depuis de nouvelles adresses IP suivant immédiatement des activités suspectes sur les endpoints d'installation.
    
    - Cette règle aide à identifier l'utilisation des accès privilégiés obtenus par l'exploitation
# Snort exemple
## Règle 1 : Détection de la modification du statut d'installation

```
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS ( 
msg:"CVE-2023-22515 - Tentative de modification setupComplete"; 
flow:to_server,established; 
content:"GET"; http_method; 
uricontent:"/server-info.action"; 
content:"bootstrapStatusProvider.applicationConfig.setupComplete=false"; http_client_body; 
reference:cve,2023-22515; 
reference:url,confluence.atlassian.com/security/cve-2023-22515; 
sid:1000001; 
rev:1; 
)
```
## Règle 2 : Détection du contournement XSRF

```
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS ( 
msg:"CVE-2023-22515 - Contournement XSRF détecté"; 
flow:to_server,established; 
content:"POST"; http_method; 
uricontent:"/setup/"; 
content:"X-Atlassian-Token|3a 20|no-check"; http_header; 
reference:cve,2023-22515; 
reference:url,blog.cloudflare.com/fr-fr/all-cloudflare-customers-protected-atlassian-cve-2023-22515; 
sid:1000002; 
rev:1; 
)
```
## Règle 3 : Création de compte administrateur
```
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS ( 
msg:"CVE-2023-22515 - Création suspecte de compte admin"; 
flow:to_server,established; 
content:"POST"; http_method; 
uricontent:"/setup/setupadministrator.action"; 
content:"username="; http_client_body; 
content:"password="; http_client_body; 
content:"confirmPassword="; http_client_body; 
reference:cve,2023-22515; 
reference:url,socprime.com/blog/cve-2023-22515-detection; 
sid:1000003; 
rev:1; 
)
```
## Règle 4 : Requête de finalisation d'installation
```
alert tcp $EXTERNAL_NET any -> $HOME_NET $HTTP_PORTS ( 
msg:"CVE-2023-22515 - Finalisation suspecte d'installation"; 
flow:to_server,established; 
content:"POST"; http_method; 
uricontent:"/setup/finishsetup.action"; 
content:"setupCompleteButton=Finish"; http_client_body; 
reference:cve,2023-22515; 
reference:url,www.cisa.gov/sites/default/files/2023-10/aa23-289a-threat-actors-exploit-atlassian-confluence-cve-2023-22515-for-initial-access_0.pdf; 
sid:1000004; 
rev:1; 
)`
```