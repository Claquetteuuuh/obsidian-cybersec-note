
La **console metasploit** est l'outil avec lequel on va **interragir avec nos modules**, pour la lancé la commande est **`msfconsole`**.

```shell
┌──(azure㉿kali)-[~]
└─$ msfconsole

                                  .::::::::::-.                     .::::::-
                                .hmMMMMMMMMMMNddds\...//M\\.../hddddmMMMMMMNo
                                 :Nm-/NMMMMMMMMMMMMM$$NMMMMm&&MMMMMMMMMMMMMMy
                                 .sm/`-yMMMMMMMMMMMM$$MMMMMN&&MMMMMMMMMMMMMh`
                                  -Nd`  :MMMMMMMMMMM$$MMMMMN&&MMMMMMMMMMMMh`
                                   -Nh` .yMMMMMMMMMM$$MMMMMN&&MMMMMMMMMMMm/
    `oo/``-hd:  ``                 .sNd  :MMMMMMMMMM$$MMMMMN&&MMMMMMMMMMm/
      .yNmMMh//+syysso-``````       -mh` :MMMMMMMMMM$$MMMMMN&&MMMMMMMMMMd
    .shMMMMN//dmNMMMMMMMMMMMMs`     `:```-o++++oooo+:/ooooo+:+o+++oooo++/
    `///omh//dMMMMMMMMMMMMMMMN/:::::/+ooso--/ydh//+s+/ossssso:--syN///os:
          /MMMMMMMMMMMMMMMMMMd.     `/++-.-yy/...osydh/-+oo:-`o//...oyodh+
          -hMMmssddd+:dMMmNMMh.     `.-=mmk.//^^^\\.^^`:++:^^o://^^^\\`::
          .sMMmo.    -dMd--:mN/`           ||--X--||          ||--X--||
........../yddy/:...+hmo-...hdd:............\\=v=//............\\=v=//.........



       =[ metasploit v6.3.10-dev-                         ]
+ -- --=[ 2303 exploits - 1203 auxiliary - 412 post       ]
+ -- --=[ 965 payloads - 46 encoders - 11 nops            ]
+ -- --=[ 9 evasion                                       ]

Metasploit tip: When in a module, use back to go
back to the top level prompt
Metasploit Documentation: https://docs.metasploit.com/

msf6 >
```

Une fois lancé, vous pouvez interragir avec la console comme si c'était un **shell banal à l'exception de quelques commandes** comme ci-dessous :

```shell
msf6 > help > help.txt 
[-] No such command 
msf6 >
```

### Help

On peut utiliser la commande **`help`** afin d'avoir des **informations sur des commandes** :

```shell
msf6 > help set
Usage: set [option] [value]

Set the given option to value. If value is omitted, print the current value.
If both are omitted, print options that are currently set.

If run from a module context, this will set the value in the module's
datastore. Use -g to operate on the global datastore. 

If setting a PAYLOAD, this command can take an index from `show payloads'.

msf6 >
```

### History

On peut utiliser la commande **`history`** pour avoir l'**historique des commandes** tapées précédemment.

```shell
msf6 > history 
1 use exploit/multi/http/nostromo_code_exec
2 set lhost 10.10.16.17 
3 set rport 80 
4 options 
5 set rhosts 10.10.29.187
6 run 
7 exit 
8 exit -y 
9 version 
10 use exploit/multi/script/web_delivery
```

### Use

La commande **`use`** permet d'**utiliser un module**. 

```shell
msf6 > use exploit/windows/smb/ms17_010_eternalblue 
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

Vous remarquerez qu'on peut toujours utiliser les commandes comme `ls`, cela signifie qu'on est pas entré dans un dossier comme on pourrait croire.

### Show options

Une commande importante lorsqu'on veut utiliser un module, est **`show options`**, elle nous **affiche les options** qu'attends le module.

```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue): 

	Name          Current Setting Required Description 
	----          --------------- -------- ----------- 
	RHOSTS                        yes The target host(s), range CIDR identifier, or hosts file with syntax 'file:'
	RPORT         445             yes The target port (TCP)
	SMBDomain     .               no (Optional) The Windows domain to use for authentication
	SMBPass                       no (Optional) The password for the specified username
	SMBUser                       no (Optional) The username to authenticate as 
	VERIFY_ARCH   true            yes Check if remote architecture matches exploit Target.
	VERIFY_TARGET true            yes Check if remote OS matches exploit Target.


Payload options (windows/x64/meterpreter/reverse_tcp): 

Name     Current Setting Required Description
----     --------------- -------- ----------- 
EXITFUNC thread          yes      Exit technique (Accepted: '', seh, thread, process, none) 
LHOST    10.10.220.191   yes      The listen address (an interface may be specified) 
LPORT    4444            yes      The listen port

Exploit target: 

	Id Name 
	-- ---- 
	0  Windows 7 and Server 2008 R2 (x64) All Service Packs


msf6 exploit(windows/smb/ms17_010_eternalblue) >
```

### Show

La commande **`show`**  peut être utilisé avec tout type de modules, si elle est exécuté à partir de l'invite msfconsole, elle **listera tous les modules**.

```
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads

Compatible Payloads
===================

#  Name                                       Disclosure Date Rank   Check Description
-  ----                                       --------------- ----   ----- ----------- 
0  generic/custom                                             manual No    Custom Payload
1  generic/shell_bind_tcp                                     manual No    Generic Command Shell, Bind TCP Inline
2  generic/shell_reverse_tcp                                  manual No    Generic Command Shell, Reverse TCP Inline 
3  windows/x64/exec                                           manual No    Windows x64 Execute Command 
4  windows/x64/loadlibrary                                    manual No    Windows x64 LoadLibrary Path
5  windows/x64/messagebox                                     manual No    Windows MessageBox x64 
6  windows/x64/meterpreter/bind_ipv6_tcp                      manual No    Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager
7  windows/x64/meterpreter/bind_ipv6_tcp_uuid                 manual No    Windows Meterpreter (Reflective Injection x64), Windows x64 IPv6 Bind TCP Stager with UUID Support
```

### Back

La commande **`back`** permet de **quitter un contexte**.

```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) >back
msf6 >
```

### Info

```shell
msf6 exploit(windows/smb/ms17_010_eternalblue) > info

       Name: MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     Module: exploit/windows/smb/ms17_010_eternalblue
   Platform: Windows
       Arch: x64
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Average
  Disclosed: 2017-03-14

Provided by:
  Equation Group
  Shadow Brokers
  sleepya
  Sean Dillon <sean.dillon@risksense.com>
  Dylan Davis <dylan.davis@risksense.com>
  thelightcosine
  wvu <wvu@metasploit.com>
  agalway-r7
  cdelafuente-r7
  cdelafuente-r7
  agalway-r7

Available targets:
      Id  Name
      --  ----
  =>  0   Automatic Target
      1   Windows 7
      2   Windows Embedded Standard 7
      3   Windows Server 2008 R2
      4   Windows 8
      5   Windows 8.1
      6   Windows Server 2012
      7   Windows 10 Pro
      8   Windows 10 Enterprise Evaluation

Check supported:
  Yes

Basic options:
  Name           Current Setting  Required  Description
  ----           ---------------  --------  -----------
  RHOSTS                          yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/
                                            basics/using-metasploit.html
  RPORT          445              yes       The target port (TCP)
  SMBDomain                       no        (Optional) The Windows domain to use for authentication. Only affects Wind
                                            ows Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines
                                            .
  SMBPass                         no        (Optional) The password for the specified username
  SMBUser                         no        (Optional) The username to authenticate as
  VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target. Only affects Windows
                                            Server 2008 R2, Windows 7, Windows Embedded Standard 7 target machines.
  VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affects Windows Server 200
                                            8 R2, Windows 7, Windows Embedded Standard 7 target machines.

Payload information:
  Space: 2000

Description:
  This module is a port of the Equation Group ETERNALBLUE exploit, part of
  the FuzzBunch toolkit released by Shadow Brokers.

  There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size
  is calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error where a
  DWORD is subtracted into a WORD. The kernel pool is groomed so that overflow
  is well laid-out to overwrite an SMBv1 buffer. Actual RIP hijack is later
  completed in srvnet!SrvNetWskReceiveComplete.

  This exploit, like the original may not trigger 100% of the time, and should be
  run continuously until triggered. It seems like the pool will get hot streaks
  and need a cool down period before the shells rain in again.

  The module will attempt to use Anonymous login, by default, to authenticate to perform the
  exploit. If the user supplies credentials in the SMBUser, SMBPass, and SMBDomain options it will use
  those instead.

  On some systems, this module may cause system instability and crashes, such as a BSOD or
  a reboot. This may be more likely with some payloads.

References:
  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
  https://nvd.nist.gov/vuln/detail/CVE-2017-0143
  https://nvd.nist.gov/vuln/detail/CVE-2017-0144
  https://nvd.nist.gov/vuln/detail/CVE-2017-0145
  https://nvd.nist.gov/vuln/detail/CVE-2017-0146
  https://nvd.nist.gov/vuln/detail/CVE-2017-0147
  https://nvd.nist.gov/vuln/detail/CVE-2017-0148
  https://github.com/RiskSense-Ops/MS17-010
  https://risksense.com/wp-content/uploads/2018/05/White-Paper_Eternal-Blue.pdf
  https://www.exploit-db.com/exploits/42030

Also known as:
  ETERNALBLUE


View the full module info with the info -d command.
```

### Search

La commande **la plus utile** est **`search`**. Elle va **rechercher** dans tous les modules le plus pertinent en fonction des termes demandé. On peut effectuer des recherches avec les *CVE*, les **noms d'exploits** ou d'un **systeme ciblé**.

```shell
msf6 >  search ms17-010

Matching Modules
================

   #  Name                                      Disclosure Date  Rank     Check  Description
   -  ----                                      ---------------  ----     -----  -----------
   0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
   4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution


Interact with a module by name or index. For example info 4, use 4 or use exploit/windows/smb/smb_doublepulsar_rce
```

Voici le tableau des ranks

| **Ranking**       | **Description**                                                                                                                                                                                                              |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Excellent Ranking** | The exploit will never crash the service. This is the case for SQL Injection, CMD execution, RFI, LFI, etc. No typical memory corruption exploits should be given this ranking unless there are extraordinary circumstances. |
| **Great Ranking**     | The exploit has a default target AND either auto-detects the appropriate target or uses an application-specifig return address AFTER a version check.                                                                        |
| **Good Ranking**      | The exploit has a default target and it is the "common case" for this type of software (English, Windows 7 for a desktop app, 2012 for server, etc).                                                                         |
| **Normal Ranking**    | The exploit is otherwise reliable, but depends on a specific version and can't (or doesn't) reliably autodetect.                                                                                                             |
| **Average Ranking**   | The exploit is generally unreliable or difficult to exploit.                                                                                                                                                                 |
| **Low Ranking**       | The exploit is nearly impossible to exploit (or under 50% success rate) for common platforms.                                                                                                                                |
| **Manual Ranking**    | The exploit is unstable or difficult to exploit and is basically a DoS. This ranking is also used when the module has no use unless specifically configured by the user                                                                                                                                                                                                                             |
