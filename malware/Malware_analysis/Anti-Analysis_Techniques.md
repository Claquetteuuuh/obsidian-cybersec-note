## Packing and Obfuscation
Malware authors often use packing and obfuscation to make an analyst's life difficult.
A packer **obfuscates**, **compresses**, or **encrypts** the contents of malware.
Specifically, a packed malware will **not show important** information when running a string search against it.

```shell
$ strings zmsuz3pinwl
!This program cannot be run in DOS mode.
RichH
.rsrc
.data
.adata
dApB
Qtq5
wn;3b:TC,n
*tVlr
D6j[
^sZ"4V
JIoL
j~AI
tYFu
7^V1
vYB09
"PeHy
M4AF#
3134
%}W\+
3A;a5
dLq<
@lyS;
```

We will notice that this sample contains mainly garbage strings that don't provide much value to us.

Let's run a Pecheck:
```shell
$ pecheck zmsuz3pinwl 
PE check for 'zmsuz3pinwl':
Entropy: 7.978052 (Min=0.0, Max=8.0)
MD5     hash: 1ebb1e268a462d56a389e8e1d06b4945
SHA-1   hash: 1ecc0b9f380896373e81ed166c34a89bded873b5
SHA-256 hash: 98c6cf0b129438ec62a628e8431e790b114ba0d82b76e625885ceedef286d6f5
SHA-512 hash: 6921532b4b5ed9514660eb408dfa5d28998f52aa206013546f9eb66e26861565f852ec7f04c85ae9be89e7721c4f1a5c31d2fae49b0e7fdfd20451191146614a
 entropy: 7.999788 (Min=0.0, Max=8.0)
 entropy: 7.961048 (Min=0.0, Max=8.0)
 entropy: 7.554513 (Min=0.0, Max=8.0)
.rsrc entropy: 6.938747 (Min=0.0, Max=8.0)
 entropy: 0.000000 (Min=0.0, Max=8.0)
.data entropy: 7.866646 (Min=0.0, Max=8.0)
.adata entropy: 0.000000 (Min=0.0, Max=8.0)
Dump Info:
----------Parsing Warnings----------

Suspicious flags set for section 0. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 1. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 2. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 3. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 4. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 5. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Suspicious flags set for section 6. Both IMAGE_SCN_MEM_WRITE and IMAGE_SCN_MEM_EXECUTE are set. This might indicate a packed executable.

Imported symbols contain entries typical of packed executables.
```

As we can see: **typical of packed executables**.
### Detect Obfuscation
#### IDA
With IDA, a disassembler, you can find if a software is obfuscated in looking the import:
![[Pasted image 20250314194322.png]]
For exemple here you can see that there is only 2 imports, that is bizzard.

Or for exemple there is the tree
![[Pasted image 20250314194350.png]]

A classic tree should be:
![[Pasted image 20250314194405.png]]
## Sandbox evasion
- **Long sleep calls**: Malware authors know that **sandboxes run for a limited time**. Therefore, they program the malware not to perform any activity for a long time after execution. The goal is to **timeout the sandbox**.
- **User activity detection**: Some malware samples will **wait for user activity before performing malicious activity**. The premise of this technique is that there will be **no user in a sandbox**. Therefore there will be **no mouse movement or typing on the keyboard**.
- **Footprinting user activity**: Some malware **checks for user files or activity**, like if there are any files in the MS Office history or internet browsing history. If no or little activity is found, the malware will **consider the machine as a sandbox and quit**.
- **Detecting VMs**: **Sandboxes run on virtual machines**. Virtual machines **leave artifacts** that can be identified by malware. For example, some **drivers installed** in VMs being run on VMWare or Virtualbox give away the fact that the machine is aÂ VM.
